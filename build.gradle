plugins {
    id 'groovy'
    id 'idea'
    id 'application'
    id 'codenarc'
}

repositories {
    mavenCentral()
}

dependencies {
    compile localGroovy()
    compile 'log4j:log4j:1.2.17'
    compile 'org.codehaus.groovy.modules.http-builder:http-builder:0.7.2'
    compile 'commons-cli:commons-cli:1.4'
    compile 'org.apache.commons:commons-math3:3.6.1'
}

mainClassName = 'NoClassName'
['runPublishNotify', 'runTests', 'prePublish', 'publishToCouch',
    'publishToInfinity', 'publishToJira', 'publishToHipchat', 'emailCycleResults'].each { name ->
    task "${name}StartScripts"(type: CreateStartScripts) {
        mainClassName = 'com.oracle.infy.qa.paradoxpublisher.' + name.capitalize()
        applicationName = name
        outputDir = new File('src/dist/bin')
        classpath = startScripts.classpath
        defaultJvmOpts = ['-Dlog4j.configuration=file:conf/log4j.xml']
        startScripts.dependsOn "${name}StartScripts"

        // The classpath generated in the .bat script lists all the jars.
        // This shortens it using a wildcard
        // Needed to prevent "input line is too long" errors running from windows cmd shell
        doLast {
            def scriptFile = file "${outputDir}/${name}.bat"
            scriptFile.text = scriptFile.text.replaceFirst(/(set CLASSPATH=.*?\\lib\\).*/,/$1*/)
        }
    }
}

group = 'com.oracle.infy.qa.paradoxpublisher'
version = '2.0.5'

distributions {
    main {
        contents {
            from("$rootDir/src/dist/") {
                include 'bin/*'
                fileMode 0755
            }
        }
    }
}

distTar {
    compression = Compression.GZIP
    extension = 'tar.gz'
}

codenarc {
    toolVersion = '1.1'
    configFile = new File('conf/codenarc.groovy')
    maxPriority1Violations = 0
    maxPriority2Violations = 0
    maxPriority3Violations = 0
    reportFormat = project.properties.'codenarc.reportFormat' ?: 'html'
}
